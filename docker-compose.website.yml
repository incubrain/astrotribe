services:
  strapi:
    build:
      context: ./apps/cms
      dockerfile: Dockerfile
    image: cms
    container_name: strapi
    ports:
      - '1337:1337'
    depends_on:
      - db
    environment:
      - NODE_ENV=development
      - HOST=localhost
      - PORT=1337
      - APP_KEYS=hzD2uEmNx0oeTio1nkAliA==,2nsFZFEZqwlednX6Z+n8hQ==,uHBO8R2S8TgT+4/5U3D0Ew==,eJg+9WdVPM1wigrr1QAs9A==
      - API_TOKEN_SALT=p/A0ZPOuZwizyOfg15aPxw==
      - ADMIN_JWT_SECRET=ktIm9hdA8hldeD+XVARBDw==
      - JWT_SECRET=/wY80OqWQiVKagSd7uQkvg==
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_NAME=strapi
      - DATABASE_USERNAME=strapi
      - DATABASE_PASSWORD=strapi
      - DATABASE_SSL=false
    networks:
      - strapi-network

  db:
    image: postgres:14
    container_name: postgres
    environment:
      POSTGRES_USER: strapi
      POSTGRES_PASSWORD: strapi
      POSTGRES_DB: strapi
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - strapi-network

  website:
    build:
      context: .
      dockerfile: apps/website/Dockerfile.dev
    image: website
    container_name: website
    depends_on:
      - strapi
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - NUXT_STRAPI_URL=http://strapi:1337
      - NUXT_PUBLIC_STRAPI_URL=http://localhost:1337
      - NUXT_PUBLIC_HMR_HOST=localhost
      - NUXT_PUBLIC_HMR_PORT=24678
      - CHOKIDAR_USEPOLLING=true
      - NODE_OPTIONS=--experimental-json-modules
    networks:
      - strapi-network
    ports:
      - '3000:3000'
      - '24678:24678'

volumes:
  pgdata:

networks:
  strapi-network:
    driver: bridge
