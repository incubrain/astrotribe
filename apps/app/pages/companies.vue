<script setup lang="ts">
definePageMeta({ name: 'Companies' })

const currentUser = useCurrentUser()
const { profile } = storeToRefs(currentUser)

const isUserBasic = profile.value.user_plan === 'free'
const showDialog = ref(isUserBasic)
const loading = useLoadingStore()

// Ads integration
const { isLoading: adsLoading } = useAdsStore()

const { store, loadMore } = useSelectData('companies', {
  orderBy: { column: 'logo_url', ascending: true },
  columns: `id, name, description, logo_url, founding_year, is_government, category, keywords, job_url,
  categories(id, name),
  social_media(id, facebook_url, linkedin_url, twitter_url, instagram_url, youtube_url),
  addresses(id, countries(name), cities(name))`,
  pagination: {
    page: 1,
    limit: 20,
  },
  initialFetch: true,
  storeKey: 'companiesFeed',
})

const handleScroll = () => {
  if (!isUserBasic) loadMore()
}

const { items } = storeToRefs(store)

const companies = computed(() =>
  items.value.map((company) => ({
    ...company,
    city: company.addresses?.[0]?.cities?.name,
    country: company.addresses?.[0]?.countries?.name,
    category: company.categories?.name,
  })),
)

const showSkeletonGrid = computed(() => loading.isLoading('companiesFeed') || adsLoading.value)
</script>

<template>
  <div :class="{ 'blur-sm pointer-events-none': isUserBasic }">
    <Transition
      name="fade"
      mode="out-in"
    >
      <IBInfiniteScroll
        v-if="!showSkeletonGrid"
        :threshold="1400"
        @update:scroll-end="handleScroll"
      >
        <CompaniesTable :companies="companies" />
      </IBInfiniteScroll>
      <CompaniesSkeleton v-else />
    </Transition>
  </div>
  <PrimeDialog
    v-model:visible="showDialog"
    :modal="true"
    header="ðŸš€ Upgrade Your Plan"
    class="w-[80vw] md:w-[30vw] rounded-md"
  >
    <div class="flex flex-col items-center gap-4 p-6 text-center">
      <!-- Upgrade Icon -->
      <Icon
        name="mdi:crown"
        size="48px"
        class="text-yellow-500"
      />

      <!-- Upgrade Message -->
      <h3 class="text-lg font-semibold text-white"> Unlock Premium Features! </h3>
      <p class="text-white text-sm">
        Upgrade your plan to access all companies and premium insights.
      </p>

      <!-- Buttons -->
      <div class="flex gap-3 mt-4">
        <NuxtLink to="/settings/payments">
          <PrimeButton
            severity="success"
            class="px-6 py-2 flex items-center gap-2"
          >
            <Icon
              name="mdi:star"
              size="20px"
              class="text-yellow-400"
            />
            Upgrade Now
          </PrimeButton>
        </NuxtLink>
      </div>
    </div>
  </PrimeDialog>
</template>
