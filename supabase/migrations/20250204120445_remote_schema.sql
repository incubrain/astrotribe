revoke delete on table "pgboss"."archive" from "anon";

revoke insert on table "pgboss"."archive" from "anon";

revoke references on table "pgboss"."archive" from "anon";

revoke select on table "pgboss"."archive" from "anon";

revoke trigger on table "pgboss"."archive" from "anon";

revoke truncate on table "pgboss"."archive" from "anon";

revoke update on table "pgboss"."archive" from "anon";

revoke delete on table "pgboss"."archive" from "authenticated";

revoke insert on table "pgboss"."archive" from "authenticated";

revoke references on table "pgboss"."archive" from "authenticated";

revoke select on table "pgboss"."archive" from "authenticated";

revoke trigger on table "pgboss"."archive" from "authenticated";

revoke truncate on table "pgboss"."archive" from "authenticated";

revoke update on table "pgboss"."archive" from "authenticated";

revoke delete on table "pgboss"."archive" from "service_role";

revoke insert on table "pgboss"."archive" from "service_role";

revoke references on table "pgboss"."archive" from "service_role";

revoke select on table "pgboss"."archive" from "service_role";

revoke trigger on table "pgboss"."archive" from "service_role";

revoke truncate on table "pgboss"."archive" from "service_role";

revoke update on table "pgboss"."archive" from "service_role";

revoke delete on table "pgboss"."job" from "anon";

revoke insert on table "pgboss"."job" from "anon";

revoke references on table "pgboss"."job" from "anon";

revoke select on table "pgboss"."job" from "anon";

revoke trigger on table "pgboss"."job" from "anon";

revoke truncate on table "pgboss"."job" from "anon";

revoke update on table "pgboss"."job" from "anon";

revoke delete on table "pgboss"."job" from "authenticated";

revoke insert on table "pgboss"."job" from "authenticated";

revoke references on table "pgboss"."job" from "authenticated";

revoke select on table "pgboss"."job" from "authenticated";

revoke trigger on table "pgboss"."job" from "authenticated";

revoke truncate on table "pgboss"."job" from "authenticated";

revoke update on table "pgboss"."job" from "authenticated";

revoke delete on table "pgboss"."job" from "service_role";

revoke insert on table "pgboss"."job" from "service_role";

revoke references on table "pgboss"."job" from "service_role";

revoke select on table "pgboss"."job" from "service_role";

revoke trigger on table "pgboss"."job" from "service_role";

revoke truncate on table "pgboss"."job" from "service_role";

revoke update on table "pgboss"."job" from "service_role";

revoke delete on table "pgboss"."queue" from "anon";

revoke insert on table "pgboss"."queue" from "anon";

revoke references on table "pgboss"."queue" from "anon";

revoke select on table "pgboss"."queue" from "anon";

revoke trigger on table "pgboss"."queue" from "anon";

revoke truncate on table "pgboss"."queue" from "anon";

revoke update on table "pgboss"."queue" from "anon";

revoke delete on table "pgboss"."queue" from "authenticated";

revoke insert on table "pgboss"."queue" from "authenticated";

revoke references on table "pgboss"."queue" from "authenticated";

revoke select on table "pgboss"."queue" from "authenticated";

revoke trigger on table "pgboss"."queue" from "authenticated";

revoke truncate on table "pgboss"."queue" from "authenticated";

revoke update on table "pgboss"."queue" from "authenticated";

revoke delete on table "pgboss"."queue" from "service_role";

revoke insert on table "pgboss"."queue" from "service_role";

revoke references on table "pgboss"."queue" from "service_role";

revoke select on table "pgboss"."queue" from "service_role";

revoke trigger on table "pgboss"."queue" from "service_role";

revoke truncate on table "pgboss"."queue" from "service_role";

revoke update on table "pgboss"."queue" from "service_role";

revoke delete on table "pgboss"."schedule" from "anon";

revoke insert on table "pgboss"."schedule" from "anon";

revoke references on table "pgboss"."schedule" from "anon";

revoke select on table "pgboss"."schedule" from "anon";

revoke trigger on table "pgboss"."schedule" from "anon";

revoke truncate on table "pgboss"."schedule" from "anon";

revoke update on table "pgboss"."schedule" from "anon";

revoke delete on table "pgboss"."schedule" from "authenticated";

revoke insert on table "pgboss"."schedule" from "authenticated";

revoke references on table "pgboss"."schedule" from "authenticated";

revoke select on table "pgboss"."schedule" from "authenticated";

revoke trigger on table "pgboss"."schedule" from "authenticated";

revoke truncate on table "pgboss"."schedule" from "authenticated";

revoke update on table "pgboss"."schedule" from "authenticated";

revoke delete on table "pgboss"."schedule" from "service_role";

revoke insert on table "pgboss"."schedule" from "service_role";

revoke references on table "pgboss"."schedule" from "service_role";

revoke select on table "pgboss"."schedule" from "service_role";

revoke trigger on table "pgboss"."schedule" from "service_role";

revoke truncate on table "pgboss"."schedule" from "service_role";

revoke update on table "pgboss"."schedule" from "service_role";

revoke delete on table "pgboss"."subscription" from "anon";

revoke insert on table "pgboss"."subscription" from "anon";

revoke references on table "pgboss"."subscription" from "anon";

revoke select on table "pgboss"."subscription" from "anon";

revoke trigger on table "pgboss"."subscription" from "anon";

revoke truncate on table "pgboss"."subscription" from "anon";

revoke update on table "pgboss"."subscription" from "anon";

revoke delete on table "pgboss"."subscription" from "authenticated";

revoke insert on table "pgboss"."subscription" from "authenticated";

revoke references on table "pgboss"."subscription" from "authenticated";

revoke select on table "pgboss"."subscription" from "authenticated";

revoke trigger on table "pgboss"."subscription" from "authenticated";

revoke truncate on table "pgboss"."subscription" from "authenticated";

revoke update on table "pgboss"."subscription" from "authenticated";

revoke delete on table "pgboss"."subscription" from "service_role";

revoke insert on table "pgboss"."subscription" from "service_role";

revoke references on table "pgboss"."subscription" from "service_role";

revoke select on table "pgboss"."subscription" from "service_role";

revoke trigger on table "pgboss"."subscription" from "service_role";

revoke truncate on table "pgboss"."subscription" from "service_role";

revoke update on table "pgboss"."subscription" from "service_role";

revoke delete on table "pgboss"."version" from "anon";

revoke insert on table "pgboss"."version" from "anon";

revoke references on table "pgboss"."version" from "anon";

revoke select on table "pgboss"."version" from "anon";

revoke trigger on table "pgboss"."version" from "anon";

revoke truncate on table "pgboss"."version" from "anon";

revoke update on table "pgboss"."version" from "anon";

revoke delete on table "pgboss"."version" from "authenticated";

revoke insert on table "pgboss"."version" from "authenticated";

revoke references on table "pgboss"."version" from "authenticated";

revoke select on table "pgboss"."version" from "authenticated";

revoke trigger on table "pgboss"."version" from "authenticated";

revoke truncate on table "pgboss"."version" from "authenticated";

revoke update on table "pgboss"."version" from "authenticated";

revoke delete on table "pgboss"."version" from "service_role";

revoke insert on table "pgboss"."version" from "service_role";

revoke references on table "pgboss"."version" from "service_role";

revoke select on table "pgboss"."version" from "service_role";

revoke trigger on table "pgboss"."version" from "service_role";

revoke truncate on table "pgboss"."version" from "service_role";

revoke update on table "pgboss"."version" from "service_role";

set check_function_bodies = off;


revoke delete on table "public"."table_maintenance_log" from "anon";

revoke insert on table "public"."table_maintenance_log" from "anon";

revoke references on table "public"."table_maintenance_log" from "anon";

revoke select on table "public"."table_maintenance_log" from "anon";

revoke trigger on table "public"."table_maintenance_log" from "anon";

revoke truncate on table "public"."table_maintenance_log" from "anon";

revoke update on table "public"."table_maintenance_log" from "anon";

revoke delete on table "public"."table_maintenance_log" from "authenticated";

revoke insert on table "public"."table_maintenance_log" from "authenticated";

revoke references on table "public"."table_maintenance_log" from "authenticated";

revoke select on table "public"."table_maintenance_log" from "authenticated";

revoke trigger on table "public"."table_maintenance_log" from "authenticated";

revoke truncate on table "public"."table_maintenance_log" from "authenticated";

revoke update on table "public"."table_maintenance_log" from "authenticated";

revoke delete on table "public"."table_maintenance_log" from "service_role";

revoke insert on table "public"."table_maintenance_log" from "service_role";

revoke references on table "public"."table_maintenance_log" from "service_role";

revoke select on table "public"."table_maintenance_log" from "service_role";

revoke trigger on table "public"."table_maintenance_log" from "service_role";

revoke truncate on table "public"."table_maintenance_log" from "service_role";

revoke update on table "public"."table_maintenance_log" from "service_role";

alter table "public"."categorized_urls" drop constraint "unique_normalized_url";

alter table "public"."customer_payments" drop constraint "uq_payment_id";

alter table "public"."customer_subscriptions" drop constraint "uq_subscription_id";

drop materialized view if exists "public"."content_scores";

drop materialized view if exists "public"."news_details";

drop index if exists "public"."idx_categorized_urls_normalized_url";

drop index if exists "public"."unique_normalized_url";

drop index if exists "public"."uq_payment_id";

drop index if exists "public"."uq_subscription_id";

alter table "public"."categorized_urls" drop column "normalized_url";

alter table "public"."categorized_urls" add column "company_id" uuid;

alter table "public"."contents" drop column "rss_url";

alter table "public"."customer_subscriptions" alter column "current_end" drop not null;

alter table "public"."customer_subscriptions" alter column "current_start" drop not null;

CREATE UNIQUE INDEX categorized_urls_original_url_key ON public.categorized_urls USING btree (original_url);

CREATE UNIQUE INDEX customer_payments_external_payment_id_key ON public.customer_payments USING btree (external_payment_id);

CREATE UNIQUE INDEX customer_subscriptions_external_subscription_id_key ON public.customer_subscriptions USING btree (external_subscription_id);

CREATE INDEX idx_categorized_urls_company_id ON public.categorized_urls USING btree (company_id);

alter table "public"."categorized_urls" add constraint "categorized_urls_company_id_fkey" FOREIGN KEY (company_id) REFERENCES companies(id) not valid;

alter table "public"."categorized_urls" validate constraint "categorized_urls_company_id_fkey";

alter table "public"."categorized_urls" add constraint "categorized_urls_original_url_key" UNIQUE using index "categorized_urls_original_url_key";

alter table "public"."customer_payments" add constraint "customer_payments_external_payment_id_key" UNIQUE using index "customer_payments_external_payment_id_key";

alter table "public"."customer_subscriptions" add constraint "customer_subscriptions_external_subscription_id_key" UNIQUE using index "customer_subscriptions_external_subscription_id_key";

set check_function_bodies = off;

create materialized view "public"."content_scores" as  SELECT c.id,
    c.content_type,
    c.title,
    c.url,
    c.hot_score,
    c.created_at,
    c.updated_at,
    ( SELECT jsonb_agg(jsonb_build_object('name', cat.name, 'isPrimary', cc.is_primary)) AS jsonb_agg
           FROM (content_categories cc
             JOIN categories cat ON ((cat.id = cc.category_id)))
          WHERE (cc.content_id = c.id)) AS categories,
    ( SELECT jsonb_agg(t.name) AS jsonb_agg
           FROM (content_tags ct
             JOIN tags t ON ((t.id = ct.tag_id)))
          WHERE (ct.content_id = c.id)) AS tags,
    ( SELECT cs.content_status
           FROM content_statuses cs
          WHERE (cs.content_id = c.id)
          ORDER BY cs.created_at DESC
         LIMIT 1) AS status
   FROM contents c
  WHERE (EXISTS ( SELECT 1
           FROM content_statuses cs
          WHERE ((cs.content_id = c.id) AND (cs.content_status = 'published'::content_status))));


CREATE OR REPLACE FUNCTION public.is_subscription_trigger()
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN EXISTS (
        SELECT 1 
        FROM pg_trigger
        JOIN pg_proc ON pg_trigger.tgfoid = pg_proc.oid
        WHERE tgname = 'customer_subscription_status_update'
        AND proname = 'update_user_plan'
    );
END;
$function$
;

create materialized view "public"."news_details" as  WITH vote_counts AS (
         SELECT votes.content_id,
            count(*) AS vote_count
           FROM votes
          GROUP BY votes.content_id
        ), bookmark_counts AS (
         SELECT bookmarks.content_id,
            count(*) AS bookmark_count
           FROM bookmarks
          GROUP BY bookmarks.content_id
        ), summary_levels AS (
         SELECT news_summaries.news_id,
            jsonb_build_object('beginner', jsonb_agg(json_build_object('id', news_summaries.id, 'summary', news_summaries.summary, 'version', news_summaries.version)) FILTER (WHERE (news_summaries.complexity_level = 'beginner'::complexity_level)), 'intermediate', jsonb_agg(json_build_object('id', news_summaries.id, 'summary', news_summaries.summary, 'version', news_summaries.version)) FILTER (WHERE (news_summaries.complexity_level = 'intermediate'::complexity_level)), 'expert', jsonb_agg(json_build_object('id', news_summaries.id, 'summary', news_summaries.summary, 'version', news_summaries.version)) FILTER (WHERE (news_summaries.complexity_level = 'expert'::complexity_level)), 'undefined', jsonb_agg(json_build_object('id', news_summaries.id, 'summary', news_summaries.summary, 'version', news_summaries.version)) FILTER (WHERE (news_summaries.complexity_level = 'undefined'::complexity_level))) AS summaries
           FROM news_summaries
          WHERE (news_summaries.is_current = true)
          GROUP BY news_summaries.news_id
        )
 SELECT c.id,
    n.title,
    c.url,
    c.hot_score,
    c.created_at,
    c.updated_at,
    n.published_at,
    n.featured_image,
    n.author,
    n.description,
    comp.name AS company_name,
    comp.logo_url AS company_logo,
    s.summaries,
    COALESCE(v.vote_count, (0)::bigint) AS vote_count,
    COALESCE(b.bookmark_count, (0)::bigint) AS bookmark_count,
    ( SELECT jsonb_agg(jsonb_build_object('name', cat.name, 'isPrimary', cc.is_primary)) AS jsonb_agg
           FROM (content_categories cc
             JOIN categories cat ON ((cat.id = cc.category_id)))
          WHERE (cc.content_id = c.id)) AS categories,
    ( SELECT jsonb_agg(t.name) AS jsonb_agg
           FROM (content_tags ct
             JOIN tags t ON ((t.id = ct.tag_id)))
          WHERE (ct.content_id = c.id)) AS tags
   FROM (((((contents c
     JOIN news n ON ((n.id = c.id)))
     LEFT JOIN companies comp ON ((comp.id = n.company_id)))
     LEFT JOIN summary_levels s ON ((s.news_id = n.id)))
     LEFT JOIN vote_counts v ON ((v.content_id = c.id)))
     LEFT JOIN bookmark_counts b ON ((b.content_id = c.id)));


CREATE OR REPLACE FUNCTION public.refresh_content_views(content_types text[] DEFAULT NULL::text[])
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Always refresh base view
    REFRESH MATERIALIZED VIEW CONCURRENTLY content_scores;
    
    -- Refresh specific content type views based on input
    IF content_types IS NULL OR 'news' = ANY(content_types) THEN
        REFRESH MATERIALIZED VIEW CONCURRENTLY public.news_details;
    END IF;
    
    -- Add more content types here as needed
    -- IF 'other_type' = ANY(content_types) THEN
    --     REFRESH MATERIALIZED VIEW CONCURRENTLY other_type_details;
    -- END IF;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.users_columns_updateable()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    current_user_role public.app_role_enum;
BEGIN
    -- Example of fetching current user's role from JWT; adjust based on your setup
    current_user_role := (auth.jwt() ->> 'user_role')::public.app_role_enum;

    RAISE LOG 'users_columns_updateable: user with role % attempted to change role or plan', current_user_role;

    -- Allow updates if they're coming from our subscription trigger
    IF TG_OP = 'UPDATE' AND public.is_subscription_trigger() THEN
        RETURN NEW;
    END IF;

    -- Allow admins, super_admins, or service_role to change roles and plans
    IF current_user_role IN ('admin', 'super_admin') OR (auth.jwt() ->> 'role') = 'service_role' THEN
        RETURN NEW;
    END IF;

    -- Prevent non-admin users from changing roles and plans
    IF NEW.role IS DISTINCT FROM OLD.role THEN
        RAISE EXCEPTION 'Changing "role" is not allowed.';
    END IF;
    IF NEW.plan IS DISTINCT FROM OLD.plan THEN
        RAISE EXCEPTION 'Changing "plan" is not allowed.';
    END IF;

    RETURN NEW;
END;
$function$
;

